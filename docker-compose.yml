# =============================================================================
# Villages Healthcare Platform - Docker Compose
#
# Profiles:
#   - dev:      Development with hot reload
#   - staging:  Production-like build (1GB memory limit)
#   - webhooks: ngrok tunnel for Clerk webhooks
#   - seed:     Database seeding
#
# Usage:
#   ./docker/scripts/start.sh dev       # Development mode
#   ./docker/scripts/start.sh staging   # Production-like mode
#   ./docker/scripts/start.sh webhooks  # Dev + ngrok
#   ./docker/scripts/start.sh seed      # Seed database
# =============================================================================

name: villages

services:
  # ===========================================================================
  # MongoDB with Replica Set (required for Prisma transactions)
  # ===========================================================================
  mongodb:
    image: mongodb/mongodb-community-server:latest
    container_name: villages-mongodb
    command: ["--replSet", "rs0", "--bind_ip_all"]
    ports:
      - "${VILLAGES_MONGO_PORT:-27017}:27017"
    volumes:
      - mongodb_data:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "try { rs.status().ok } catch(e) { quit(1) }"]
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 30s
    restart: unless-stopped
    stop_grace_period: 60s
    networks:
      - villages-network

  # ===========================================================================
  # MongoDB Replica Set Initializer (one-shot service)
  # ===========================================================================
  mongodb-init:
    image: mongodb/mongodb-community-server:latest
    container_name: villages-mongodb-init
    depends_on:
      - mongodb
    entrypoint: []
    command: >
      bash -c "
        echo 'Waiting for MongoDB to be ready...' &&
        sleep 5 &&
        mongosh --host mongodb:27017 --eval \"
          try {
            rs.status();
            print('Replica set already initialized');
          } catch(e) {
            rs.initiate({_id:'rs0', members:[{_id:0, host:'mongodb:27017'}]});
            print('Replica set initialized');
          }
        \"
      "
    networks:
      - villages-network
    restart: "no"

  # ===========================================================================
  # Next.js Application - Development Mode (hot reload)
  # ===========================================================================
  app:
    build:
      context: .
      dockerfile: docker/Dockerfile
      target: dev
    container_name: villages-app-dev
    ports:
      - "${VILLAGES_APP_PORT:-3000}:3000"
    volumes:
      - .:/app:cached
      - /app/node_modules
      - next_cache:/app/.next
    environment:
      - NODE_ENV=development
      - DATABASE_URL=mongodb://mongodb:27017/villages-dev?retryWrites=true&w=majority&replicaSet=rs0&directConnection=true
      - NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=${NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY}
      - CLERK_SECRET_KEY=${CLERK_SECRET_KEY}
      - CLERK_WEBHOOK_SECRET=${CLERK_WEBHOOK_SECRET}
      - RESEND_API_KEY=${RESEND_API_KEY:-}
      - WATCHPACK_POLLING=true
      - CHOKIDAR_USEPOLLING=true
    depends_on:
      mongodb-init:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
    restart: unless-stopped
    stop_grace_period: 30s
    networks:
      - villages-network
    profiles:
      - dev

  # ===========================================================================
  # Next.js Application - Staging Mode (production-like)
  # ===========================================================================
  app-staging:
    build:
      context: .
      dockerfile: docker/Dockerfile
      target: runner
    container_name: villages-app-staging
    ports:
      - "${VILLAGES_APP_PORT:-3000}:3000"
    environment:
      - NODE_ENV=production
      - DATABASE_URL=mongodb://mongodb:27017/villages-staging?retryWrites=true&w=majority&replicaSet=rs0&directConnection=true
      - NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=${NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY}
      - CLERK_SECRET_KEY=${CLERK_SECRET_KEY}
      - CLERK_WEBHOOK_SECRET=${CLERK_WEBHOOK_SECRET}
      - RESEND_API_KEY=${RESEND_API_KEY:-}
    depends_on:
      mongodb-init:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped
    stop_grace_period: 30s
    deploy:
      resources:
        limits:
          memory: 1024M
    networks:
      - villages-network
    profiles:
      - staging

  # ===========================================================================
  # ngrok Tunnel for Clerk Webhooks
  # ===========================================================================
  ngrok:
    image: ngrok/ngrok:latest
    container_name: villages-ngrok
    command: ["http", "app:3000", "--log=stdout"]
    ports:
      - "${VILLAGES_NGROK_PORT:-4040}:4040"
    environment:
      - NGROK_AUTHTOKEN=${NGROK_AUTHTOKEN:-}
    depends_on:
      - app
    networks:
      - villages-network
    profiles:
      - webhooks

  # ===========================================================================
  # Database Seeder (one-shot service)
  # ===========================================================================
  db-seed:
    build:
      context: .
      dockerfile: docker/Dockerfile
      target: dev
    container_name: villages-db-seed
    command: >
      sh -c "
        echo '========================================' &&
        echo 'Villages Database Seeding' &&
        echo '========================================' &&
        echo '' &&
        echo '[1/2] Running Prisma schema push...' &&
        npx prisma db push --skip-generate &&
        echo '' &&
        echo '[2/2] Seeding healthcare tags...' &&
        npx tsx scripts/seed-healthcare-tags.ts &&
        echo '' &&
        echo 'Database seeding complete!' &&
        echo '========================================'
      "
    environment:
      - DATABASE_URL=mongodb://mongodb:27017/villages-dev?retryWrites=true&w=majority&replicaSet=rs0&directConnection=true
    volumes:
      - .:/app:cached
      - /app/node_modules
    depends_on:
      mongodb-init:
        condition: service_completed_successfully
    networks:
      - villages-network
    profiles:
      - seed

# =============================================================================
# Volumes
# =============================================================================
volumes:
  mongodb_data:
    name: villages-mongodb-data
  next_cache:
    name: villages-next-cache

# =============================================================================
# Networks
# =============================================================================
networks:
  villages-network:
    name: villages-network
    driver: bridge
